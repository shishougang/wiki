<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>c9, Performance Monitor Control Register</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="c9, Performance Monitor Control Register"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-07-28 22:30:17 HKT"/>
<meta name="author" content="Shi Shougang"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../assets/stylesheet.css" />
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="org-div-home-and-up" style="text-align:right;font-size:70%;white-space:nowrap;">
 <a accesskey="h" href="../../index.html"> UP </a>
 |
 <a accesskey="H" href="../../index.html"> HOME </a>
</div>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">c9, Performance Monitor Control Register</h1>

<p>The purpose of the Performance MoNitor Control (PMNC) Register is to
control the operation of the four Performance Monitor Count Registers,
and the Cycle Counter Register:<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>
</p>
<p>
The PMNC Register is:
</p><ul>
<li>a read/write register common to Secure and Nonsecure states
</li>
<li>accessible as determined by <b>c9, User Enable Register</b>.<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup>
</li>
</ul>



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">enable the perfromance counter</a>
<ul>
<li><a href="#sec-1-1">c9, User Enable Register</a></li>
<li><a href="#sec-1-2">c9, Interrupt Enable Clear Register</a></li>
</ul>
</li>
<li><a href="#sec-2">access the cycle-counter from the user-mode</a>
<ul>
<li><a href="#sec-2-1">c9, Cycle Count Register</a></li>
<li><a href="#sec-2-2">c9, Performance Monitor Control Register</a></li>
<li><a href="#sec-2-3">c9, Count Enable Set Register</a></li>
<li><a href="#sec-2-4">c9, Overflow Flag Status Register</a></li>
</ul>
</li>
<li><a href="#sec-3">How to use it</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">enable the perfromance counter</h2>
<div class="outline-text-2" id="text-1">

<p>Accessing the performance counters isn't difficult, but you have to enable them from kernel-mode. By default the counters are disabled.
</p>
<p>
In a nutshell you have to execute the following two lines inside the
kernel. Either as a loadable module or just adding the two lines
somewhere in the <b>board-init</b> will do:
</p>



<pre class="src src-c"><span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">enable user-mode access to the performance counter</span><span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">asm</span> (<span style="color: #ffa07a;">"MCR p15, 0, %0, C9, C14, 0\n\t"</span> :: <span style="color: #ffa07a;">"r"</span>(1)); 

  <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">disable counter overflow interrupts (just in case)</span><span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">asm</span> (<span style="color: #ffa07a;">"MCR p15, 0, %0, C9, C14, 2\n\t"</span> :: <span style="color: #ffa07a;">"r"</span>(0x8000000f));
</pre>

<p>
Once you did this the cycle counter will start incrementing for each
cycle. Overflows of the register will go unnoticed and don't cause any
problems (except they might mess up your measurements).
</p>

</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">c9, User Enable Register</h3>
<div class="outline-text-3" id="text-1-1">

<p><code>asm ("MCR p15, 0, %0, C9, C14, 0\n\t" :: "r"(1));</code>
</p>
<p>
The purpose of the USER ENable (USEREN) Register is to enable User
mode to have access to the Performance Monitor Registers.<sup><a class="footref" name="fnr.3" href="#fn.3">3</a></sup>
</p>
<p>
To access the USEREN Register, read or write CP15 with:
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c14, 0 ; Read USEREN Register</code>
</p>
<p>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c14, 0 ; Write USEREN Register</code>
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">c9, Interrupt Enable Clear Register</h3>
<div class="outline-text-3" id="text-1-2">

<p><code>asm ("MCR p15, 0, %0, C9, C14, 2\n\t" :: "r"(0x8000000f));</code>
</p>
<p>
The purpose of the INTerrupt ENable Clear (INTENC) Register is to
determine if any of the Performance Monitor Count Registers,
PMCNT0-PMCNT3 and CCNT, generate an interrupt on overflow.<sup><a class="footref" name="fnr.4" href="#fn.4">4</a></sup>
</p>
<p>
To access the INTENC Register, read or write CP15 with:
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c14, 2 ; Read INTENC Register</code>
</p>
<p>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c14, 2 ; Write INTENC Register</code>
</p></div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">access the cycle-counter from the user-mode</h2>
<div class="outline-text-2" id="text-2">

<p>Now you want to access the cycle-counter from the user-mode:
</p>
<p>
We start with a function that reads the register:
</p>


<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #00ffff;">inline</span> <span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">int</span> <span style="color: #87cefa;">get_cyclecount</span> (<span style="color: #98fb98;">void</span>)
{
  <span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">value</span>;
  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Read CCNT Register</span>
  <span style="color: #00ffff;">asm</span> <span style="color: #00ffff;">volatile</span> (<span style="color: #ffa07a;">"MRC p15, 0, %0, c9, c13, 0\t\n"</span>: <span style="color: #ffa07a;">"=r"</span>(value));  
  <span style="color: #00ffff;">return</span> value;
}
</pre>

<p>
And you most likely want to reset and set the divider as well:
</p>


<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #00ffff;">inline</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">init_perfcounters</span> (<span style="color: #98fb98;">int32_t</span> <span style="color: #eedd82;">do_reset</span>, <span style="color: #98fb98;">int32_t</span> <span style="color: #eedd82;">enable_divider</span>)
{
  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">in general enable all counters (including cycle counter)</span>
  <span style="color: #98fb98;">int32_t</span> <span style="color: #eedd82;">value</span> = 1;

  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">peform reset:  </span>
  <span style="color: #00ffff;">if</span> (do_reset)
  {
    value |= 2;     <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">reset all counters to zero.</span>
    value |= 4;     <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">reset cycle counter to zero.</span>
  } 

  <span style="color: #00ffff;">if</span> (enable_divider)
    value |= 8;     <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">enable "by 64" divider for CCNT.</span>

  value |= 16;

  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">program the performance-counter control-register:</span>
  <span style="color: #00ffff;">asm</span> <span style="color: #00ffff;">volatile</span> (<span style="color: #ffa07a;">"MCR p15, 0, %0, c9, c12, 0\t\n"</span> :: <span style="color: #ffa07a;">"r"</span>(value));  

  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">enable all counters:  </span>
  <span style="color: #00ffff;">asm</span> <span style="color: #00ffff;">volatile</span> (<span style="color: #ffa07a;">"MCR p15, 0, %0, c9, c12, 1\t\n"</span> :: <span style="color: #ffa07a;">"r"</span>(0x8000000f));  

  <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">clear overflows:</span>
  <span style="color: #00ffff;">asm</span> <span style="color: #00ffff;">volatile</span> (<span style="color: #ffa07a;">"MCR p15, 0, %0, c9, c12, 3\t\n"</span> :: <span style="color: #ffa07a;">"r"</span>(0x8000000f));
}
</pre>

<p>
<code>do_reset</code> will set the cycle-counter to zero. Easy as that.
</p>
<p>
<code>enable_diver</code> will enable the 1/64 cycle divider. Without this flag set
you'll be measuring each cycle. With it enabled the counter gets
increased for every 64 cycles. This is useful if you want to measure
long times that would otherwise cause the counter to overflow.
</p>

</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">c9, Cycle Count Register</h3>
<div class="outline-text-3" id="text-2-1">

<p><code>asm volatile ("MRC p15, 0, %0, c9, c13, 0\t\n": "=r"(value));</code>
</p>
<p>
The purpose of the Cycle CouNT (CCNT) Register is to count the number
of clock cycles since the register was reset. <sup><a class="footref" name="fnr.5" href="#fn.5">5</a></sup>
</p>
<p>
To access the CCNT Register, read or write CP15 with:
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c13, 0 ; Read CCNT Register</code>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c13, 0 ; Write CCNT Register</code>
</p></div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">c9, Performance Monitor Control Register</h3>
<div class="outline-text-3" id="text-2-2">

<p><code>asm volatile ("MCR p15, 0, %0, c9, c12, 0\t\n" :: "r"(value));</code>
</p>
<p>
To access the PMNC Register, read or write CP15 with:<sup><a class="footref" name="fnr.1.2" href="#fn.1">1</a></sup>
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c12, 0 ; Read PMNC Register</code>
</p>
<p>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c12, 0 ; Write PMNC Register</code>
</p>
</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">c9, Count Enable Set Register</h3>
<div class="outline-text-3" id="text-2-3">

<p><code>asm volatile ("MCR p15, 0, %0, c9, c12, 1\t\n" :: "r"(0x8000000f));</code>
The purpose of the CouNT ENable Set (CNTENS) Register is to enable or
disable any of the Performance Monitor Count Registers.
</p>
<p>
When reading this register, any enable that reads as 0 indicates the
counter is disabled. Any enable that reads as 1 indicates the counter
is enabled.
</p>
<p>
When writing this register, any enable written with a value of 0 is
ignored, that is, not updated. Any enable written with a value of 1
indicates the counter is enabled.<sup><a class="footref" name="fnr.6" href="#fn.6">6</a></sup>
</p>
<p>
To access the CNTENS Register, read or write CP15 with:
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c12, 1 ; Read CNTENS Register</code>
</p>
<p>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c12, 1 ; Write CNTENS Register</code>
</p>
</div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">c9, Overflow Flag Status Register</h3>
<div class="outline-text-3" id="text-2-4">

<p><code>asm volatile ("MCR p15, 0, %0, c9, c12, 3\t\n" :: "r"(0x8000000f));</code>
The purpose of the Overflow Flag Status (FLAG) Register is to enable
or disable any of the performance monitor counters producing an
overflow flag.<sup><a class="footref" name="fnr.7" href="#fn.7">7</a></sup>
</p>
<p>
To access the FLAG Register, read or write CP15 with:
</p>
<p>
<code>MRC p15, 0, &lt;Rd&gt;, c9, c12, 3 ; Read FLAG Register</code>
</p>
<p>
<code>MCR p15, 0, &lt;Rd&gt;, c9, c12, 3 ; Write FLAG Register</code>
</p>

</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">How to use it</h2>
<div class="outline-text-2" id="text-3">




<pre class="src src-c"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">init counters:</span>
 init_perfcounters (1, 0); 

 <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">measure the counting overhead:</span>
 <span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">overhead</span> = get_cyclecount();
 overhead = get_cyclecount() - overhead;    

 <span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">t</span> = get_cyclecount();

 <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">do some stuff here..</span>
 call_my_function();

 t = get_cyclecount() - t;

 printf (<span style="color: #ffc0cb; font-weight: bold;">"</span><span style="color: #ffa07a;">function took exactly %d cycles (including function call)</span>
<span style="color: #ffa07a;"> "</span>, t - overhead);
</pre>


<p>
Should work on all Cortex-A8 CPUs.
</p>
<p>
 <b>some notes:</b>
</p>
<p>
Using these counters you'll measure the exact time between the two
calls to <code>get_cyclecount()</code> including everything spent in other
processes or in the kernel. There is no way to restrict the
measurement to your process or a single thread.
</p>
<p>
Also calling <code>get_cyclecount()</code> isn't free. It will compile to a single
asm-instruction, but moves from the co-processor will stall the entire
ARM pipeline. The overhead is quite high and can skew your
measurement. Fortunately the overhead is also fixed, so you can
measure it and subtract it from your timings.
</p>
<p>
In this  example I did that for every measurement. Don't do this in
practice. An interrupt will sooner or later occur between the two
calls and skew your measurements even further. I suggest that you
measure the overhead a couple of times on an idle system, ignore all
outsiders and use a fixed constant instead.<sup><a class="footref" name="fnr.8" href="#fn.8">8</a></sup>
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, Performance Monitor Control Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">Cortex-A8 Technical Reference Manua</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.3" href="#fnr.3">3</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, User Enable Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.4" href="#fnr.4">4</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, Interrupt Enable Clear Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.5" href="#fnr.5">5</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, Cycle Count Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.6" href="#fnr.6">6</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, Count Enable Set Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.7" href="#fnr.7">7</a></sup> <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0344k/Bgbcjifb.html">c9, Overflow Flag Status Register</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.8" href="#fnr.8">8</a></sup> <a href="http://stackoverflow.com/questions/3247373/how-to-measure-program-execution-time-in-arm-cortex-a8-processor">stackoverflow</a>
</p>



</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-07-28 22:30:17 HKT</p>
<p class="author">Author: Shi Shougang</p>
<p class="creator">Org version 7.8.09 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
